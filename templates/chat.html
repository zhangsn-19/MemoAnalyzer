<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .memory-item {
            /* border: 1px solid #ccc; */
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
        }

        mark {
            background-color: yellow;
            font-weight: bold;
        }

        body {
            background-color: #f4f4f4;
        }
        #chat-container {
            display: flex;
            margin: 50px auto;
            max-width: 80%;
        }
        #chat-list {
            width: 20%;
            margin-right: 20px;
            background: white;
            border-radius: 5px;
            box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.1);
            padding: 10px;
        }
        #chat-box {
            width: 80%;
            background: white;
            border-radius: 5px;
            box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.1);
            padding: 10px;
            position: relative; /* 为浮动框提供相对定位 */
        }
        .message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
            max-width: 75%;
            position: relative;
        }
        .message.user {
            background-color: #dcf8c6;
            margin-left: auto;
            text-align: left;
        }
        .message.assistant {
            background-color: #f1f0f0;
            text-align: left;
        }
        #message-form {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        #message-form input[type="text"] {
            width: 80%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        #message-form button {
            width: 15%;
            padding: 10px;
            border-radius: 5px;
            border: none;
            background: #28a745;
            color: white;
            cursor: pointer;
        }
        .memory-type-item {
            display: inline-block;
        }
        .chat-link {
            display: block;
            padding: 10px;
            margin-bottom: 5px;
            background-color: #f8f9fa;
            border-radius: 5px;
            text-decoration: none;
            color: #000;
        }
        .chat-link:hover {
            background-color: #e2e6ea;
        }
        .active-chat {
            background-color: #28a745;
            color: #fff;
        }
        /* 浮动框样式 */
        #plugin-container {
            display: none;
            position: absolute;
            top: 10px;
            right: 10px;
            width: 300px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            padding: 15px;
        }
        input[type="checkbox"] {
            width: 30px;
            height: 30px;
        }
        .privacy-item{
            margin-bottom: 10px;
        }
        .privacy-item:hover{
            background-color: #DCF8C0
        }
    </style>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
</head>
<body>
    <div id="plugin-container" style="display:none; max-height: 700px; overflow-y:auto; top:50px; left:50px; width:300px; padding:20px; background:white; box-shadow: 0px 0px 10px rgba(0,0,0,0.1); border-radius:5px;">
        <!-- Memory Generation Stage -->
    </div>
    <div id="new-memory-container" style="display:none; position:fixed; top:50px; right:450px; width:500px; padding:20px; z-index: 999;background:white; box-shadow: 0px 0px 10px rgba(0,0,0,0.1); border-radius:5px;">
        <select id="group" value="1">
            <option value="1">Dimond</option>
            <option value="2">vertical</option>
        </select>
        <input type="text" placeholder="New Memory" style="border: 1px solid #ccc; padding: 5px; border-radius: 5px;">
        <button type="button" id="add-memory-button">Add Memory</button>
        <button type="button" id="close-plugin">Close</button>
    </div>
    <div id="past-memory-container" style="display:none;height: 700px;overflow-y:auto; position:fixed; top:50px; left:50px; width:300px; padding:20px; background:white; box-shadow: 0px 0px 10px rgba(0,0,0,0.1); border-radius:5px;">使用过往记忆
    </div>
    <button type="button" id="finish-button" style="display:none; position:fixed; bottom:50px; right:50px;z-index = 999">完成编辑</button>
    
    <div id="chat-container">
        <div id="chat-list">
            <h4>Chats</h4>
            {% for chat in chat_list %}
            <a href="{{ url_for('chat', chat_name=chat) }}" 
               class="chat-link {% if selected_chat == chat %}active-chat{% endif %}">
                {{ chat }}
            </a>
            {% endfor %}
            <form method="POST">
                <input type="text" name="new_chat_name" placeholder="New chat name" class="form-control my-2" required>
                <button type="submit" class="btn btn-primary btn-block">Start New Chat</button>
            </form>
        </div>        
        <div id="chat-box" style="min-height: 300px;">
            <h4>{{ selected_chat }}</h4>
            <div id="messages">
                {% for conversation in conversations %}
                <!-- 
                    只遍历assistant的回复，跳过user的输入
                -->
                {% if conversation.startswith('assistant') %}
                <div class="message assistant">
                    {{ conversation.split(': ', 1)[1] | safe }}
                </div>
                
                {% else %}
                <div class="message user">
                    {{ conversation.split(': ', 1)[1] | safe }}
                </div>
                {% endif %}
                {% endfor %}
            </div>
            <form id="message-form">
                <input type="hidden" name="chat_name" value="{{ selected_chat }}">
                <input type="text" name="message" placeholder="Type your message..." required>
                <!-- 将 type 从 submit 改为 button -->
                <button type="button" id="send-button">Send</button>
            </form>
        </div>
    </div>

    <script>


    const pastMemoryContainer = document.getElementById('past-memory-container');
    const colors = ["#FFBD7B", "#FFACAD", "#FAE85B", "#A5EECB", "#C6C5FE"]
    let memoryList = {};
    function displayPastMemory(memoryList) {
        renderMemoryItems(memoryList);
        console.log(Object.keys(memoryList), "keys");
        const memoryDiv = document.querySelector('#new-memory');
        memoryDiv.querySelector('svg').addEventListener('click', () => {
            document.getElementById('new-memory-container').style.display = 'block';
            console.log("click");

        })
        const newMemory = document.getElementById('new-memory-container');
        newMemory.querySelector('#add-memory-button').addEventListener('click', () => {
            const memoryType = newMemory.querySelector('#group').value;
            const memoryText = newMemory.querySelector('input').value;
            if(memoryList[memoryType]){
                memoryList[memoryType].push(memoryText);
            }
            else{
                memoryList[memoryType] = [memoryText];
            }
            console.log(memoryList);
            renderMemoryItems(memoryList);
            newMemory.style.display = 'none';
        });
        newMemory.querySelector('#close-plugin').addEventListener('click', () => {
            newMemory.style.display = 'none';
        });

        

        

        document.querySelectorAll('.memoryType').forEach((phraseElement) => {
            phraseElement.addEventListener('click', (event) => {
                const type = event.target.innerText;

                document.querySelectorAll('.memory-item').forEach((memoryElement) => {

                const memoryPhrase = memoryElement.querySelector('.phrase').innerText;
                // 找到 memoryPhrase 在memoryList中的key
                const memoryType = Object.keys(memoryList).find(key => memoryList[key].includes(memoryPhrase));  
                console.log(memoryType, type);
                if (memoryType === type) {
                    console.log(memoryElement);
                    memoryElement.style.display = 'flex';
                } else {
                    memoryElement.style.display = 'none';
                }
                });
            });
        });
    }

    function renderMemoryItems(memoryList) {
        pastMemoryContainer.innerHTML = '';
        // 给key分配颜色
        Object.keys(memoryList).forEach((type, index) => {
            console.log(type)
            const memoryDiv = document.createElement('div');
            memoryDiv.className = 'memory-type-item';
            memoryDiv.innerHTML = `
                <span class="memoryType" contenteditable="true" style="background-color:${colors[index]};border: 1px solid #ccc; padding: 5px; border-radius: 5px;">${type}</span>
            `;
            pastMemoryContainer.appendChild(memoryDiv);
        });

        const memoryDiv = document.createElement('div');
        memoryDiv.id = 'new-memory';
        memoryDiv.className = 'memory-type-item';
        memoryDiv.innerHTML = `
        <svg width="30px" height="30px" viewBox="0 0 17 17" fill="none" xmlns="http://www.w3.org/2000/svg">
<rect width="17" height="17" rx="8.5" fill="#80E0FF"/>
<path d="M12.284 7.125C12.4233 7.125 12.5572 7.1525 12.6855 7.2075C12.8138 7.2625 12.9238 7.33583 13.0155 7.4275C13.1072 7.51917 13.1805 7.62917 13.2355 7.7575C13.2905 7.88583 13.318 8.01967 13.318 8.159C13.318 8.30567 13.2905 8.44133 13.2355 8.566C13.1805 8.69067 13.1072 8.79883 13.0155 8.8905C12.9238 8.98217 12.8138 9.0555 12.6855 9.1105C12.5572 9.1655 12.4233 9.193 12.284 9.193H9.193V12.284C9.193 12.4307 9.1655 12.5663 9.1105 12.691C9.0555 12.8157 8.98217 12.9238 8.8905 13.0155C8.79883 13.1072 8.68883 13.1805 8.5605 13.2355C8.43217 13.2905 8.29833 13.318 8.159 13.318C8.01233 13.318 7.87667 13.2905 7.752 13.2355C7.62733 13.1805 7.51917 13.1072 7.4275 13.0155C7.33583 12.9238 7.2625 12.8157 7.2075 12.691C7.1525 12.5663 7.125 12.4307 7.125 12.284V9.193H4.034C3.88733 9.193 3.75167 9.1655 3.627 9.1105C3.50233 9.0555 3.39417 8.98217 3.3025 8.8905C3.21083 8.79883 3.1375 8.69067 3.0825 8.566C3.0275 8.44133 3 8.30567 3 8.159C3 8.01967 3.0275 7.88583 3.0825 7.7575C3.1375 7.62917 3.21083 7.51917 3.3025 7.4275C3.39417 7.33583 3.50233 7.2625 3.627 7.2075C3.75167 7.1525 3.88733 7.125 4.034 7.125H7.125V4.034C7.125 3.89467 7.1525 3.76083 7.2075 3.6325C7.2625 3.50417 7.33583 3.39417 7.4275 3.3025C7.51917 3.21083 7.62733 3.1375 7.752 3.0825C7.87667 3.0275 8.01233 3 8.159 3C8.445 3 8.68883 3.10083 8.8905 3.3025C9.09217 3.50417 9.193 3.748 9.193 4.034V7.125H12.284Z" fill="black"/>
</svg>
        `;
        pastMemoryContainer.appendChild(memoryDiv);

        Object.keys(memoryList).forEach((type, index) => {
            memoryList[type].forEach((memory, memoryIndex) => {
                const memoryDiv = document.createElement('div');
                memoryDiv.className = 'memory-item';
                memoryDiv.innerHTML = `
                    <input type="checkbox"  checked />
                    <div class="phrase" contenteditable="true" style="background-color:${colors[index]}; width:220px;border: 1px solid #ccc; padding: 5px; border-radius: 5px;">${memory}</div>
                    <svg width="40px" height="40px" viewBox="0 0 11 11" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M2.125 2.125V10H8.875V2.125H2.125Z" stroke="#9C9C9C" stroke-opacity="0.5" stroke-linejoin="round"/>
<path d="M4.375 4.375V7.75" stroke="#9C9C9C" stroke-opacity="0.5" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M6.625 4.375V7.75" stroke="#9C9C9C" stroke-opacity="0.5" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M1 2.125H10" stroke="#9C9C9C" stroke-opacity="0.5" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M3.8125 2.125L4.50627 1H6.50767L7.1875 2.125H3.8125Z" stroke="#9C9C9C" stroke-opacity="0.5" stroke-linejoin="round"/>
</svg>

                    `;
                memoryDiv.querySelector('svg').addEventListener('click', () => {
                memoryList[type] = memoryList[type].filter((_, i) => i !== memoryIndex);
                memoryDiv.remove();
            });
                pastMemoryContainer.appendChild(memoryDiv);
            });
        });
    }
        function displayPrivacyItems(privacy) {
            console.log(privacy);
            const plugin_container = document.getElementById('plugin-container');
            privacy.forEach(item => {
                const privacyItemDiv = document.createElement('div');
                privacyItemDiv.className = 'privacy-item';
                privacyItemDiv.innerHTML = `
                <div>Confidence: ${item.confidence}</div>
                <div>${item.privacy_info}</div>
                `;
                plugin_container.appendChild(privacyItemDiv);
                privacyItemDiv.addEventListener('click', () => {
                    const pastUsedMemoryContainer = document.getElementById('used-memory-container');
                    if (pastUsedMemoryContainer) {
                        pastUsedMemoryContainer.remove();
                    }
                    const usedMemoryContainer = document.createElement('div');
                    usedMemoryContainer.id = 'used-memory-container';
                    usedMemory = item.used_memory
                    usedUserInput = item.used_user_input
                    usedMemory.forEach(memory => {
                        const usedMemoryDiv = document.createElement('div');
                        usedMemoryDiv.innerHTML = `
                        <div>Used Memory:</div>
                        <div>${memory}</div>
                        `;
                        usedMemoryContainer.appendChild(usedMemoryDiv);
                    });

                    usedUserInput.forEach(userInput => {
                        highlightOriginalText(usedUserInput)
                        const usedUserInputDiv = document.createElement('div');
                        usedUserInputDiv.innerHTML = `
                        <div>Used User Input:</div>
                        <div>${userInput}</div>
                        `;
                        usedMemoryContainer.appendChild(usedUserInputDiv);
                    });
                    plugin_container.appendChild(usedMemoryContainer);
                });
            });
        }

        function displayMemoryItems(memorySuggestions, memoryList) {
            const plugin_container = document.getElementById('plugin-container');
            // let phraseDiv = document.getElementById('phrase');
            // let confidenceBar = document.getElementById('confidence');
            
    
            
            for (let i = 0; i < memorySuggestions.length; i++) {
                const memoryItem = memorySuggestions[i];
                const memoryItemDiv = document.createElement('div');
                const type = memoryItem.type
                const color = colors[Object.keys(memoryList).indexOf(type)]
                memoryItemDiv.className = 'memory-item';
                memoryItemDiv.innerHTML = `
                <div id="memory-stage">
                    可信度：${memoryItem.confidence }%
                    <span class="type" style="background-color: ${color}">${type}</span>
                    <input type="checkbox" />
                    <div class="phrase" contenteditable="true" style="border: 1px solid #ccc; padding: 5px; border-radius: 5px;">${memoryItem.memoryText}</div>
                </div>
                `;
                plugin_container.appendChild(memoryItemDiv);
            }
        }

        // 高亮文本
        function highlightOriginalText(memorySuggestions, memoryList) {
            // 找到最新发送的消息
            let messageInput = document.querySelector('input[name="message"]');
            let originalText = messageInput.value;
            memorySuggestions.forEach(item => {
                // let regex = new RegExp(`(${item.originalText})`, 'gi');
                // 高亮匹配的文本
                const type_info = item.type
                let type_index = Object.keys(memoryList).indexOf(type_info)
                console.log("type_index", type_index);
                // 如果不存在，则新建一个颜色
                if (type_index === -1) {
                    type_index = Object.keys(memoryList).length
                    colors.push(`#${Math.floor(Math.random()*16777215).toString(16)}`)
                }
                const color = colors[type_index]
                originalText = originalText.replace(item.originalText, `<mark style="background-color: ${color};">${item.originalText}</mark>`);
            });
            const plugin_container = document.getElementById('plugin-container');
            const currentPrompt = document.createElement('div');
            currentPrompt.innerHTML = originalText
            plugin_container.appendChild(currentPrompt);
        }




        document.getElementById('send-button').onclick = function(event) {
            console.log("Send button clicked.");
            event.preventDefault(); // 阻止表单默认提交
            const messageInput = document.querySelector('input[name="message"]');
            const message = messageInput.value;
            // 推入message user
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerText = message;
            messagesDiv.appendChild(messageDiv);
            // const xhr0 = new XMLHttpRequest();
            // xhr0.open("GET", "{{ url_for('get_memory') }}", true);
            // xhr0.onreadystatechange = function() {
            //     if (xhr0.readyState === 4 && xhr0.status === 200) {
            //         console.log("Received memory response.");
            //         const response = JSON.parse(xhr0.responseText);
            //         // response.memory是字符串，需要转换为对象
            //         memoryList = JSON.parse(response.memory);
            //         console.log(memoryList);
            //         displayPastMemory(memoryList);
            //         const xhr = new XMLHttpRequest();
            //         const memory_type = Object.keys(memoryList).join(", ")
            //         xhr.open("POST", "{{ url_for('memory_evaluation') }}", true);
            //         xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            //         xhr.onreadystatechange = function() {
            //             if (xhr.readyState === 4 && xhr.status === 200) {
            //                 console.log("Received memory evaluation response.");
            //                 const response = JSON.parse(xhr.responseText);
            //                 console.log(response);
            //                 const memorySuggestions = response.memory_suggestions;  // 假设这是个数组

            //                 // 显示多个记忆条目
            //                 displayMemoryItems(memorySuggestions, memoryList);
            //                 highlightOriginalText(memorySuggestions, memoryList);

            //                 // 显示插件
            //                 document.getElementById('plugin-container').style.display = 'block';
            //                 document.getElementById('past-memory-container').style.display = 'block';
            //                 document.getElementById('finish-button').style.display = 'block';
                    
            //             }
            //         };
            //         xhr.send(`message=${encodeURIComponent(message)}&memory_type=${memory_type}`)
            //     }
            // };
            // xhr0.send(); 
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "{{ url_for('get_privacy') }}", true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    console.log("Received privacy response.");
                    // 返回的是字符串，需要转换为json对象
                    const response = JSON.parse(xhr.responseText);
                    displayPrivacyItems(response.privacy);
                    document.getElementById('plugin-container').style.display = 'block';
                }
            };     
            xhr.send(`message=${encodeURIComponent(message)}`)      
            
        }
        document.getElementById('finish-button').onclick = function(event){
            let checkedMemories = [];
            document.querySelectorAll('.memory-item input[type="checkbox"]:checked').forEach(checkbox => {
                let memory = checkbox.nextElementSibling.innerText;
                checkedMemories.push(memory);
            });
            console.log(checkedMemories)
            checkedMemories = checkedMemories.join("; ")

            let checkboxes = document.querySelectorAll('#memory-stage input[type="checkbox"]');
            checkboxes.forEach(function(checkbox) {
                var parent = checkbox.parentElement;
                var type = parent.querySelector('.type').textContent;
                var memoryText = parent.querySelector('.phrase').textContent;
                if (checkbox.checked) {
                    if(memoryList[type]){
                        memoryList[type].push(memoryText);
                    }
                    else{
                        memoryList[type] = [memoryText];
                    }
                }
            });
            console.log(memoryList);
            console.log(JSON.stringify(memoryList)); 
            const xhr1 = new XMLHttpRequest();
            xhr1.open("POST", "{{ url_for('update_memory') }}", true);
            xhr1.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr1.onreadystatechange = function() {
                if (xhr1.readyState === 4 && xhr1.status === 200) {
                    console.log("Received memory update response.");
                    const response = JSON.parse(xhr1.responseText);
                    console.log(response);
                }
            };
            xhr1.send(`memory=${JSON.stringify(memoryList)}`)
            // 隐藏
            document.getElementById('plugin-container').style.display = 'none';       
            document.getElementById('past-memory-container').style.display = 'none';
            document.getElementById('finish-button').style.display = 'none';
            const xhr = new XMLHttpRequest();
            const messageInput = document.querySelector('input[name="message"]');
            const message = messageInput.value;
            event.preventDefault(); 
            xhr.open("POST", "{{ url_for('chat') }}", true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    console.log("Received chat response.");
                    const response = JSON.parse(xhr.responseText);
                    console.log(response);
                    const conversation = response.conversation;  // 假设这是个数组

                    // 更新聊天框
                    const messagesDiv = document.getElementById('messages');
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message user';
                    messageDiv.innerText = message;
                    messagesDiv.appendChild(messageDiv);

                    conversation.forEach(item => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'message assistant';
                        messageDiv.innerText = item;
                        messagesDiv.appendChild(messageDiv);
                    });
                    
                }
                location.reload()
            };
            xhr.send(`message=${encodeURIComponent(message)}&chat_name={{ selected_chat }}&memory=${checkedMemories}`)
                    
            }
        // 双击修改原始文本
        function modifyOriginalText(index) {
            const messageInput = document.querySelector('input[name="message"]');
            const newText = prompt("Modify the text:", messageInput.value);

            if (newText) {
                // 更新用户输入框中的文本
                messageInput.value = newText;

                // 更新后台的记忆信息
                memorySuggestions[index].originalText = newText;
            }
        }

        document.getElementById('close-plugin').onclick = function() {
            // 隐藏插件并发送最终请求
            document.getElementById('plugin-container').style.display = 'none';
            sendFinalChat(document.querySelector('input[name="message"]').value);
        };

    </script>
</body>
</html>
